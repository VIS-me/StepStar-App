<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>StepStar</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div id="app" class="app-viewport"></div>

    <div class="tab-bar">
        <div class="tab-item active" id="btn-home" onclick="window.navigate('home', this)"><i>üè†</i><span id="txt-home"></span></div>
        <div class="tab-item" id="btn-rank" onclick="window.navigate('rank', this)"><i>üèÜ</i><span id="txt-rank"></span></div>
        <div class="tab-item" id="btn-tour" onclick="window.navigate('tour', this)"><i>üèÅ</i><span id="txt-tour"></span></div>
        <div class="tab-item" id="btn-prof" onclick="window.navigate('prof', this)"><i>üë§</i><span id="txt-prof"></span></div>
    </div>

    <script src="assets.js"></script>
    <script src="pages.js"></script>

    <script type="module">
        import { syncUser, db, doc, updateDoc, increment, arrayUnion } from './firebase-logic.js';

        window.tg = window.Telegram.WebApp;
        
        // –ì–ª–æ–±–∞–ª—å–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
        window.userState = { 
            frame: 'white', 
            steps: 0, 
            coins: 0, 
            isVip: false,
            calories: 0,
            inventoryFrames: ['white']
        };

        const userLang = window.tg.initDataUnsafe?.user?.language_code;
        window.appLang = (userLang === 'ru' || userLang === 'uk') ? userLang : 'en';

        // 1. –ù–ê–í–ò–ì–ê–¶–ò–Ø (–ü—Ä–∏–≤—è–∑—ã–≤–∞–µ–º –∫ window, —á—Ç–æ–±—ã onclick –≤ HTML —Ä–∞–±–æ—Ç–∞–ª)
        window.navigate = function(pageId, el) {
            const app = document.getElementById('app');
            const user = window.tg.initDataUnsafe?.user || { first_name: "User", photo_url: "" };
            
            // –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞–ª–∏—á–∏—è Pages
            if (typeof Pages === 'undefined') {
                console.error("Pages.js not loaded!");
                return;
            }

            if (pageId === 'shop') {
                app.innerHTML = Pages.shop(user, window.userState, window.appLang);
            } else if (Pages[pageId]) {
                app.innerHTML = Pages[pageId](user, window.userState, window.appLang);
            }

            if (el) {
                document.querySelectorAll('.tab-item').forEach(i => i.classList.remove('active'));
                el.classList.add('active');
            }
            if (window.tg.HapticFeedback) window.tg.HapticFeedback.impactOccurred('light');
        };

        // 2. –û–ë–†–ê–ë–û–¢–ö–ê –ú–ê–ì–ê–ó–ò–ù–ê
        window.handleFrameAction = async function(color, price) {
            const userId = window.tg.initDataUnsafe?.user?.id;
            if (!userId) return;

            const userRef = doc(db, "users", String(userId));
            const isOwned = window.userState.inventoryFrames.includes(color);

            if (isOwned) {
                window.userState.frame = color;
                await updateDoc(userRef, { "selected.frame": color });
                window.navigate('shop');
            } else {
                if (window.userState.coins >= price) {
                    const confirmMsg = window.appLang === 'ru' ? `–ö—É–ø–∏—Ç—å –∑–∞ ${price} üí∞?` : `Buy for ${price} üí∞?`;
                    window.tg.showConfirm(confirmMsg, async (confirm) => {
                        if (confirm) {
                            try {
                                await updateDoc(userRef, {
                                    "economy.balance": increment(-price),
                                    "inventory.frames": arrayUnion(color),
                                    "selected.frame": color
                                });
                                window.userState.coins -= price;
                                window.userState.frame = color;
                                window.userState.inventoryFrames.push(color);
                                window.navigate('shop');
                                if (window.tg.HapticFeedback) window.tg.HapticFeedback.notificationOccurred('success');
                            } catch (e) { console.error(e); }
                        }
                    });
                } else {
                    window.tg.showAlert(window.appLang === 'ru' ? "–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –º–æ–Ω–µ—Ç!" : "Not enough coins!");
                }
            }
        };

        // –°–æ—Ü–∏–∞–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏
        window.inviteFriends = function() {
            const botUsername = 'StepStarAppBot'; 
            const text = encodeURIComponent("–î–∞–≤–∞–π —à–∞–≥–∞—Ç—å –≤–º–µ—Å—Ç–µ! üëü");
            window.tg.openTelegramLink(`https://t.me/share/url?url=https://t.me/${botUsername}&text=${text}`);
        };

        window.shareResult = function(steps) {
            const text = encodeURIComponent(`–ú–æ–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç: ${steps} —à–∞–≥–æ–≤! üëü`);
            window.tg.openTelegramLink(`https://t.me/share/url?url=https://t.me/StepStarAppBot&text=${text}`);
        };

        window.processTournamentJoin = function(fee) {
            if (window.userState.coins >= fee) {
                window.tg.showConfirm("–£—á–∞—Å—Ç–≤–æ–≤–∞—Ç—å?", async (c) => {
                    if (c) {
                        const userRef = doc(db, "users", String(window.tg.initDataUnsafe.user.id));
                        await updateDoc(userRef, { "economy.balance": increment(-fee), "tournament.registered": true });
                        window.userState.coins -= fee;
                        window.navigate('tour');
                    }
                });
            }
        };

        // 3. –°–¢–ê–†–¢ –ü–†–ò–õ–û–ñ–ï–ù–ò–Ø
        const initApp = async () => {
            window.tg.expand();
            window.tg.ready();

            const tgUser = window.tg.initDataUnsafe?.user;
            if (tgUser) {
                try {
                    const dbData = await syncUser(tgUser);
                    if (dbData) {
                        window.userState.coins = dbData.economy?.balance || 0;
                        window.userState.steps = dbData.stats?.steps_total || 0;
                        window.userState.frame = dbData.selected?.frame || 'white';
                        window.userState.inventoryFrames = dbData.inventory?.frames || ['white'];
                    }
                } catch (e) { console.error("Firebase error:", e); }
            }

            // –ü–µ—Ä–µ–≤–æ–¥ –º–µ–Ω—é
            if (typeof t === 'function') {
                document.getElementById('txt-home').innerText = t('home', window.appLang);
                document.getElementById('txt-rank').innerText = t('rank', window.appLang);
                document.getElementById('txt-tour').innerText = t('tour', window.appLang);
                document.getElementById('txt-prof').innerText = t('prof', window.appLang);
            }

            // –ó–∞–≥—Ä—É–∑–∫–∞ –ø–µ—Ä–≤–æ–π —Å—Ç—Ä–∞–Ω–∏—Ü—ã
            window.navigate('home', document.getElementById('btn-home'));
        };

        initApp();
    </script>
</body>
</html>
