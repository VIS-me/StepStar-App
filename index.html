<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>StepStar</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <link rel="stylesheet" href="style.css">
    
    <script src="https://www.gstatic.com/firebasejs/10.8.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.8.1/firebase-firestore-compat.js"></script>
</head>
<body>
    <div id="app" class="app-viewport">
        <div style="padding:50px; text-align:center; color:white; font-family:sans-serif;">
            <div class="loader">üöÄ</div>
            <p>–ó–∞–ø—É—Å–∫ StepStar...</p>
        </div>
    </div>

    <div class="tab-bar">
        <div class="tab-item active" id="btn-home" onclick="navigate('home', this)"><i>üè†</i><span id="txt-home">–î–æ–º</span></div>
        <div class="tab-item" id="btn-rank" onclick="navigate('rank', this)"><i>üèÜ</i><span id="txt-rank">–†–∞–Ω–≥</span></div>
        <div class="tab-item" id="btn-tour" onclick="navigate('tour', this)"><i>üèÅ</i><span id="txt-tour">–¢—É—Ä–Ω–∏—Ä</span></div>
        <div class="tab-item" id="btn-prof" onclick="navigate('prof', this)"><i>üë§</i><span id="txt-prof">–ü—Ä–æ—Ñ–∏–ª—å</span></div>
    </div>

    <script src="assets.js"></script>
    <script src="pages.js"></script>

    <script>
        // 1. –ù–∞—Å—Ç—Ä–æ–π–∫–∞ Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyD6XgHahHPQ2X0G98sMVGRd-68LigZK4_Q",
            authDomain: "stepstarapp.firebaseapp.com",
            projectId: "stepstarapp",
            storageBucket: "stepstarapp.firebasestorage.app",
            messagingSenderId: "515498492922",
            appId: "1:515498492922:web:76255dfa72995e03261a43"
        };

        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        // 2. –ì–ª–æ–±–∞–ª—å–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
        window.tg = window.Telegram.WebApp;
        window.userState = { 
            frame: 'white', steps: 0, coins: 0, isVip: false, inventoryFrames: ['white'] 
        };
        
        const userLang = window.tg.initDataUnsafe?.user?.language_code;
        window.appLang = (userLang === 'ru' || userLang === 'uk') ? userLang : 'en';

        // 3. –ù–∞–≤–∏–≥–∞—Ü–∏—è
        window.navigate = function(pageId, el) {
            const app = document.getElementById('app');
            const user = window.tg.initDataUnsafe?.user || { first_name: "Walker", photo_url: "" };
            
            if (typeof Pages !== 'undefined' && Pages[pageId]) {
                app.innerHTML = Pages[pageId](user, window.userState, window.appLang);
                if (window.tg.HapticFeedback) window.tg.HapticFeedback.impactOccurred('light');
            }
            if (el) {
                document.querySelectorAll('.tab-item').forEach(i => i.classList.remove('active'));
                el.classList.add('active');
            }
        };

        // 4. –õ–æ–≥–∏–∫–∞ Firebase
        async function syncUser(tgUser) {
            const userRef = db.collection("users").doc(String(tgUser.id));
            const doc = await userRef.get();

            const freshData = {
                name: tgUser.first_name || "Walker",
                photo_url: tgUser.photo_url || "",
                last_seen: firebase.firestore.FieldValue.serverTimestamp()
            };

            if (doc.exists) {
                await userRef.update(freshData);
                return doc.data();
            } else {
                const newUser = {
                    ...freshData,
                    economy: { balance: 0, total_earned: 0 },
                    inventory: { frames: ["white"] },
                    selected: { frame: "white" },
                    stats: { steps_today: 0, calories_today: 0, steps_total: 0 },
                    settings: { is_vip: false, privacy_mode: "public" }
                };
                await userRef.set(newUser);
                return newUser;
            }
        }

        // 5. –§—É–Ω–∫—Ü–∏–∏ –∫–Ω–æ–ø–æ–∫ (–ú–∞–≥–∞–∑–∏–Ω, VIP, –®–∞—Ä–∏–Ω–≥)
        window.handleFrameAction = async function(color, price) {
            const userId = window.tg.initDataUnsafe?.user?.id;
            if (!userId) return;

            const userRef = db.collection("users").doc(String(userId));
            const isOwned = window.userState.inventoryFrames.includes(color);

            if (isOwned) {
                window.userState.frame = color;
                await userRef.update({ "selected.frame": color });
                window.navigate('shop');
            } else {
                if (window.userState.coins >= price) {
                    window.tg.showConfirm(`–ö—É–ø–∏—Ç—å –∑–∞ ${price} üí∞?`, async (confirm) => {
                        if (confirm) {
                            await userRef.update({
                                "economy.balance": firebase.firestore.FieldValue.increment(-price),
                                "inventory.frames": firebase.firestore.FieldValue.arrayUnion(color),
                                "selected.frame": color
                            });
                            window.userState.coins -= price;
                            window.userState.frame = color;
                            window.userState.inventoryFrames.push(color);
                            window.navigate('shop');
                            window.tg.HapticFeedback.notificationOccurred('success');
                        }
                    });
                } else {
                    window.tg.showAlert("–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –º–æ–Ω–µ—Ç!");
                }
            }
        };

        window.handleVipPurchase = async function() {
            const userId = window.tg.initDataUnsafe?.user?.id;
            if (window.userState.coins >= 2500) {
                window.tg.showConfirm("–ö—É–ø–∏—Ç—å VIP –∑–∞ 2500 üí∞?", async (confirm) => {
                    if(confirm) {
                        const userRef = db.collection("users").doc(String(userId));
                        await userRef.update({
                            "settings.is_vip": true,
                            "economy.balance": firebase.firestore.FieldValue.increment(-2500),
                            "inventory.frames": firebase.firestore.FieldValue.arrayUnion('gold_vip_frame'),
                            "selected.frame": 'gold_vip_frame'
                        });
                        window.userState.isVip = true;
                        window.userState.coins -= 2500;
                        window.userState.frame = 'gold_vip_frame';
                        window.navigate('prof');
                        window.tg.showAlert("üëë VIP –ê–ö–¢–ò–í–ò–†–û–í–ê–ù!");
                    }
                });
            } else {
                window.tg.showAlert("–ù—É–∂–Ω–æ 2500 –º–æ–Ω–µ—Ç!");
            }
        };

        window.shareResult = function(steps) {
            const msg = t('shareMsg', window.appLang).replace('{n}', steps);
            const url = `https://t.me/share/url?url=https://t.me/StepStarAppBot&text=${encodeURIComponent(msg)}`;
            window.tg.openTelegramLink(url);
        };

        // 6. –°—Ç–∞—Ä—Ç
        async function start() {
            window.tg.ready();
            window.tg.expand();

            try {
                const tgUser = window.tg.initDataUnsafe?.user;
                if (tgUser) {
                    const data = await syncUser(tgUser);
                    window.userState.coins = data.economy?.balance || 0;
                    window.userState.steps = data.stats?.steps_today || 0;
                    window.userState.frame = data.selected?.frame || 'white';
                    window.userState.inventoryFrames = data.inventory?.frames || ['white'];
                    window.userState.isVip = data.settings?.is_vip || false;
                }
            } catch (e) {
                console.error("Firebase Sync Error:", e);
            }

            // –õ–æ–∫–∞–ª–∏–∑–∞—Ü–∏—è –º–µ–Ω—é
            if (typeof t === 'function') {
                document.getElementById('txt-home').innerText = t('home', window.appLang);
                document.getElementById('txt-rank').innerText = t('rank', window.appLang);
                document.getElementById('txt-tour').innerText = t('tour', window.appLang);
                document.getElementById('txt-prof').innerText = t('prof', window.appLang);
            }

            window.navigate('home', document.getElementById('btn-home'));
        }

        start();
    </script>
</body>
</html>
