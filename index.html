<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>StepStar</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.8.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.8.1/firebase-firestore-compat.js"></script>

    <style>
        :root {
            --main-color: #248bcf;
            --bg-color: #1a1c20;
            --text-color: #ffffff;
            --secondary-bg: rgba(255,255,255,0.08);
            --accent-gold: #FFD700;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; }

        body {
            margin: 0; padding: 0;
            font-family: -apple-system, system-ui, sans-serif;
            background: var(--bg-color); color: var(--text-color);
            height: 100vh; width: 100vw; overflow: hidden;
        }

        .app-viewport { height: calc(100vh - 70px); overflow-y: auto; padding-bottom: 20px; }

        /* HOME PAGE STYLES */
        .stats-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; padding: 0 20px; margin-top: 20px; }
        .stat-card { background: var(--secondary-bg); padding: 12px 5px; border-radius: 18px; text-align: center; }
        .stat-card b { display: block; font-size: 16px; margin-bottom: 2px; }
        .stat-card span { font-size: 10px; opacity: 0.5; text-transform: uppercase; }

        /* RATING PAGE STYLES */
        .leader-hero-container {
            position: relative;
            width: 100%;
            height: 40vh;
            overflow: hidden;
        }
        .leader-img-full {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        .leader-info-overlay {
            position: absolute;
            bottom: 50px;
            left: 25px;
            text-align: left;
            z-index: 5;
            text-shadow: 0 2px 10px rgba(0,0,0,0.8);
        }
        
        .my-rank-card {
            background: rgba(255, 255, 255, 0.07);
            backdrop-filter: blur(15px);
            -webkit-backdrop-filter: blur(15px);
            margin: -30px 20px 20px;
            padding: 12px 25px;
            border-radius: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: relative;
            z-index: 10;
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 10px 25px rgba(0,0,0,0.4);
        }

        .section-title { padding: 10px 25px 5px; font-size: 11px; font-weight: bold; opacity: 0.4; letter-spacing: 1.2px; text-transform: uppercase; }
        
        /* TABLE STYLES */
        .table-row { display: flex; align-items: center; padding: 12px 25px; border-bottom: 1px solid rgba(255,255,255,0.03); }
        .rank-num { width: 25px; font-size: 14px; opacity: 0.5; font-weight: bold; }
        .rank-photo-mini { width: 38px; height: 38px; border-radius: 50%; margin: 0 15px; object-fit: cover; background: #333; }
        
        /* TAB BAR */
        .tab-bar { 
            height: 70px; display: flex; background: #15171a; 
            position: fixed; bottom: 0; width: 100%; 
            border-top: 1px solid rgba(255,255,255,0.1); z-index: 1000;
        }
        .tab-item { flex: 1; text-align: center; padding-top: 12px; color: #666; font-size: 10px; cursor: pointer; }
        .tab-item.active { color: var(--main-color); }
        .tab-item i { display: block; font-size: 22px; margin-bottom: 4px; font-style: normal; }

        .main-button { width: 90%; background: var(--main-color); color: white; border: none; padding: 16px; border-radius: 20px; font-size: 15px; font-weight: bold; margin: 15px auto; display: block; cursor: pointer; }
        
        .avatar-wrapper { position: relative; width: 90px; height: 90px; display: flex; align-items: center; justify-content: center; margin: 0 auto; }
        .user-avatar { width: 84%; height: 84%; border-radius: 50%; object-fit: cover; background: #333; }
    </style>
</head>
<body>

    <div id="app" class="app-viewport">
        <div style="display:flex; justify-content:center; align-items:center; height:100%;">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
    </div>

    <div class="tab-bar">
        <div class="tab-item active" onclick="window.navigate('home', this)"><i>üè†</i><span>–î–æ–º</span></div>
        <div class="tab-item" onclick="window.navigate('rank', this)"><i>üèÜ</i><span>–†–µ–π—Ç–∏–Ω–≥</span></div>
        <div class="tab-item" onclick="window.navigate('tour', this)"><i>üèÅ</i><span>–¢—É—Ä–Ω–∏—Ä</span></div>
        <div class="tab-item" onclick="window.navigate('prof', this)"><i>üë§</i><span>–ü—Ä–æ—Ñ–∏–ª—å</span></div>
    </div>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyD6XgHahHPQ2X0G98sMVGRd-68LigZK4_Q",
            authDomain: "stepstarapp.firebaseapp.com",
            projectId: "stepstarapp",
            storageBucket: "stepstarapp.firebasestorage.app",
            messagingSenderId: "515498492922",
            appId: "1:515498492922:web:76255dfa72995e03261a43"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        window.tg = window.Telegram.WebApp;
        window.userState = { id: '', steps: 0, friends: [] };
        window.friendUsers = [];

        window.navigate = function(pageId, el) {
            const user = window.tg.initDataUnsafe?.user || { first_name: "User", photo_url: "" };
            const appDiv = document.getElementById('app');
            if (el) {
                document.querySelectorAll('.tab-item').forEach(i => i.classList.remove('active'));
                el.classList.add('active');
            }

            if (pageId === 'home') {
                const s = { dist: (window.userState.steps * 0.00075).toFixed(2), kcal: (window.userState.steps * 0.04).toFixed(0), time: (window.userState.steps / 100).toFixed(0) };
                const offset = 628 - (628 * Math.min(window.userState.steps / 10000, 1));
                appDiv.innerHTML = `
                    <div style="text-align:center; padding-top:20px;">
                        <div class="avatar-wrapper"><img src="${user.photo_url}" class="user-avatar" onerror="this.src='https://ui-avatars.com/api/?name=${user.first_name}'"></div>
                        <h3>${user.first_name}</h3>
                        <div style="position:relative; width:220px; height:220px; margin:20px auto; display:flex; align-items:center; justify-content:center;">
                            <svg width="220" height="220" style="transform: rotate(-90deg); position:absolute;"><circle stroke="rgba(255,255,255,0.1)" stroke-width="12" fill="transparent" r="100" cx="110" cy="110"/><circle stroke="var(--main-color)" stroke-width="12" fill="transparent" r="100" cx="110" cy="110" style="stroke-dashoffset:${offset}; stroke-dasharray:628; transition:0.5s; stroke-linecap:round;"/></svg>
                            <div><h1 style="margin:0; font-size:42px;">${window.userState.steps.toLocaleString()}</h1><div style="font-size:12px; opacity:0.5;">—à–∞–≥–æ–≤ —Å–µ–≥–æ–¥–Ω—è</div></div>
                        </div>
                        <div class="stats-grid">
                            <div class="stat-card"><b>${s.kcal}</b><span>–∫–∫–∞–ª</span></div>
                            <div class="stat-card"><b>${s.dist}</b><span>–∫–º</span></div>
                            <div class="stat-card"><b>${s.time}</b><span>–º–∏–Ω</span></div>
                        </div>
                        <button class="main-button" style="margin-top:30px;" onclick="window.shareResult()">–ü–æ–¥–µ–ª–∏—Ç—å—Å—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–º</button>
                    </div>`;
            }

            if (pageId === 'rank') {
                const leader = window.friendUsers[0] || { name: "–õ–∏–¥–µ—Ä", photo_url: "https://images.unsplash.com/photo-1551632432-c735e7a03288?w=800" };
                const myIndex = window.friendUsers.findIndex(u => u.id === window.userState.id) + 1;
                const top3 = window.friendUsers.slice(0, 3);

                appDiv.innerHTML = `
                    <div class="leader-hero-container">
                        <img src="${leader.photo_url}" class="leader-img-full" onerror="this.src='https://ui-avatars.com/api/?name=L&size=512'">
                        <div class="leader-info-overlay">
                            <div style="font-size:10px; opacity:0.8; letter-spacing:1px; margin-bottom:2px;">–õ–ò–î–ï–† –ù–ï–î–ï–õ–ò</div>
                            <h2 style="margin:0; font-size:22px;">${leader.name}</h2>
                        </div>
                    </div>

                    <div class="my-rank-card">
                        <div>
                            <div style="font-size:9px; opacity:0.5; margin-bottom:2px; letter-spacing:0.5px;">–í–ê–® –†–ê–ù–ì</div>
                            <div style="font-size:20px; font-weight:bold; color:var(--main-color);">#${myIndex || '-'}</div>
                        </div>
                        <div style="text-align:right;">
                            <div style="font-size:9px; opacity:0.5; margin-bottom:2px; letter-spacing:0.5px;">–®–ê–ì–ò</div>
                            <div style="font-size:18px; font-weight:bold;">${window.userState.steps.toLocaleString()}</div>
                        </div>
                    </div>

                    <div class="section-title">–¢–û–ü-3 –î—Ä—É–∑–µ–π</div>
                    <div class="rating-list">
                        ${top3.map((u, i) => `
                            <div class="table-row">
                                <span class="rank-num">${i + 1}</span>
                                <img src="${u.photo_url}" class="rank-photo-mini" onerror="this.src='https://ui-avatars.com/api/?name=${u.name}'">
                                <span style="flex:1;">${u.name} ${u.id === window.userState.id ? '(–í—ã)' : ''}</span>
                                <b style="${i === 0 ? 'color:var(--accent-gold);' : ''}">${(u.stats?.steps_today || 0).toLocaleString()}</b>
                            </div>
                        `).join('')}
                    </div>
                    
                    <button class="main-button" style="margin-top:20px;" onclick="window.inviteFriends()">–ü—Ä–∏–≥–ª–∞—Å–∏—Ç—å –¥—Ä—É–∑–µ–π</button>`;
            }
            
            if (pageId === 'tour' || pageId === 'prof' || pageId === 'shop') {
                appDiv.innerHTML = `<div style="padding:40px; text-align:center; opacity:0.5;">–†–∞–∑–¥–µ–ª –ø–æ–ø–æ–ª–Ω–∏—Ç—Å—è –≤ —Å–ª–µ–¥—É—é—â–µ–º –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏</div>`;
            }
        };

        // –õ–æ–≥–∏–∫–∞ –∫–Ω–æ–ø–∫–∏ "–ü–æ–¥–µ–ª–∏—Ç—å—Å—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–º"
        window.shareResult = () => {
            const steps = window.userState.steps.toLocaleString();
            const text = `–Ø –ø—Ä–æ—à–µ–ª —Å–µ–≥–æ–¥–Ω—è ${steps} —à–∞–≥–æ–≤ –≤ StepStar! üëü\n–ü–æ–ø—Ä–æ–±—É–π –æ–±–æ–≥–Ω–∞—Ç—å –º–µ–Ω—è:`;
            const link = `https://t.me/StepStarAppBot/start?startapp=${window.userState.id}`;
            window.tg.openTelegramLink(`https://t.me/share/url?url=${encodeURIComponent(link)}&text=${encodeURIComponent(text)}`);
        };

        // –û–±—ã—á–Ω–æ–µ –ø—Ä–∏–≥–ª–∞—à–µ–Ω–∏–µ –¥–ª—è –≤–∫–ª–∞–¥–∫–∏ –†–µ–π—Ç–∏–Ω–≥
        window.inviteFriends = () => {
            const link = `https://t.me/StepStarAppBot/start?startapp=${window.userState.id}`;
            window.tg.openTelegramLink(`https://t.me/share/url?url=${encodeURIComponent(link)}&text=–ö—Ç–æ –ø—Ä–æ–π–¥–µ—Ç –±–æ–ª—å—à–µ? üëü`);
        };

        async function loadData() {
            try {
                const tgUser = window.tg.initDataUnsafe?.user;
                if (!tgUser) { window.navigate('home'); return; }
                const userRef = db.collection("users").doc(String(tgUser.id));
                const doc = await userRef.get();
                if (doc.exists) {
                    const d = doc.data();
                    window.userState = { id: String(tgUser.id), steps: d.stats?.steps_today || 0, friends: d.friends || [] };
                    const fIds = [...window.userState.friends, window.userState.id];
                    const fSnap = await db.collection("users").where(firebase.firestore.FieldPath.documentId(), 'in', fIds.slice(0, 10)).get();
                    window.friendUsers = fSnap.docs.map(doc => ({ id: doc.id, ...doc.data() })).sort((a,b) => (b.stats?.steps_today || 0) - (a.stats?.steps_today || 0));
                }
                window.navigate('home');
            } catch (e) { console.error(e); window.navigate('home'); }
        }

        window.tg.ready();
        window.tg.expand();
        loadData();
    </script>
</body>
</html>
