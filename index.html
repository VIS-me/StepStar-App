<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>StepStar</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div id="app" class="app-viewport"></div>

    <div class="tab-bar">
        <div class="tab-item active" id="btn-home" onclick="window.navigate('home', this)"><i>üè†</i><span id="txt-home"></span></div>
        <div class="tab-item" id="btn-rank" onclick="window.navigate('rank', this)"><i>üèÜ</i><span id="txt-rank"></span></div>
        <div class="tab-item" id="btn-tour" onclick="window.navigate('tour', this)"><i>üèÅ</i><span id="txt-tour"></span></div>
        <div class="tab-item" id="btn-prof" onclick="window.navigate('prof', this)"><i>üë§</i><span id="txt-prof"></span></div>
    </div>

    <script src="assets.js"></script>
    <script src="pages.js"></script>

    <script type="module">
        // –ò–º–ø–æ—Ä—Ç–∏—Ä—É–µ–º –Ω—É–∂–Ω—ã–µ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –±–∞–∑–æ–π –Ω–∞–ø—Ä—è–º—É—é
        import { syncUser, buyVip, db, doc, updateDoc, increment, arrayUnion } from './firebase-logic.js';

        window.tg = window.Telegram.WebApp;
        
        // 1. –†–∞—Å—à–∏—Ä–µ–Ω–Ω–æ–µ –≥–ª–æ–±–∞–ª—å–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
        window.userState = { 
            frame: 'white', 
            steps: 0, 
            coins: 0, 
            isVip: false,
            calories: 0,
            inventoryFrames: ['white'] // –°–ø–∏—Å–æ–∫ –∫—É–ø–ª–µ–Ω–Ω—ã—Ö —Ä–∞–º–æ–∫ (–±–µ–ª–∞—è –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é)
        };

        const userLang = window.tg.initDataUnsafe?.user?.language_code;
        window.appLang = (userLang === 'ru' || userLang === 'uk') ? userLang : 'en';

        // 2. –§–£–ù–ö–¶–ò–Ø –ù–ê–í–ò–ì–ê–¶–ò–ò
        window.navigate = function(pageId, el) {
            try {
                const app = document.getElementById('app');
                const user = window.tg.initDataUnsafe?.user || { first_name: "User", photo_url: "" };
                
                if (pageId === 'shop') {
                    app.innerHTML = Pages.shop(user, window.userState, window.appLang);
                    return;
                }

                if (typeof Pages !== 'undefined' && Pages[pageId]) {
                    app.innerHTML = Pages[pageId](user, window.userState, window.appLang);
                }

                if (el) {
                    document.querySelectorAll('.tab-item').forEach(i => i.classList.remove('active'));
                    el.classList.add('active');
                }
                if (window.tg.HapticFeedback) window.tg.HapticFeedback.impactOccurred('light');
            } catch (e) {
                console.error("Navigation error:", e);
            }
        };

        // 3. –õ–û–ì–ò–ö–ê –ú–ê–ì–ê–ó–ò–ù–ê (–ü–û–ö–£–ü–ö–ê –ò –í–´–ë–û–†)
        window.handleFrameAction = async function(color, price) {
            const userId = window.tg.initDataUnsafe?.user?.id;
            if (!userId) return;

            const userRef = doc(db, "users", String(userId));
            const isOwned = window.userState.inventoryFrames.includes(color);

            if (isOwned) {
                // –ï—Å–ª–∏ —Ä–∞–º–∫–∞ —É–∂–µ –∫—É–ø–ª–µ–Ω–∞ ‚Äî –ø—Ä–æ—Å—Ç–æ –Ω–∞–¥–µ–≤–∞–µ–º
                window.userState.frame = color;
                await updateDoc(userRef, { "selected.frame": color });
                window.navigate('shop');
                if (window.tg.HapticFeedback) window.tg.HapticFeedback.impactOccurred('light');
            } else {
                // –ï—Å–ª–∏ –Ω–µ –∫—É–ø–ª–µ–Ω–∞ ‚Äî –ø—Ä–æ–≤–µ—Ä—è–µ–º –±–∞–ª–∞–Ω—Å –∏ –ø–æ–∫—É–ø–∞–µ–º
                if (window.userState.coins >= price) {
                    const confirmMsg = window.appLang === 'ru' ? `–ö—É–ø–∏—Ç—å —Ä–∞–º–∫—É –∑–∞ ${price} üí∞?` : `Buy for ${price} üí∞?`;
                    window.tg.showConfirm(confirmMsg, async (confirm) => {
                        if (confirm) {
                            try {
                                await updateDoc(userRef, {
                                    "economy.balance": increment(-price),
                                    "inventory.frames": arrayUnion(color),
                                    "selected.frame": color
                                });

                                // –û–±–Ω–æ–≤–ª—è–µ–º –ª–æ–∫–∞–ª—å–Ω–æ
                                window.userState.coins -= price;
                                window.userState.frame = color;
                                window.userState.inventoryFrames.push(color);
                                
                                window.navigate('shop');
                                if (window.tg.HapticFeedback) window.tg.HapticFeedback.notificationOccurred('success');
                            } catch (e) { console.error("Purchase error:", e); }
                        }
                    });
                } else {
                    window.tg.showAlert(window.appLang === 'ru' ? "–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –º–æ–Ω–µ—Ç!" : "Not enough coins!");
                }
            }
        };

        // –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ —Å–æ—Ü—Å–µ—Ç–µ–π
        window.inviteFriends = function() {
            const botUsername = 'StepStarAppBot'; 
            const inviteText = encodeURIComponent("–ü—Ä–∏–≤–µ—Ç! –î–∞–≤–∞–π —Å—á–∏—Ç–∞—Ç—å —à–∞–≥–∏ –≤–º–µ—Å—Ç–µ –≤ StepStar üëü");
            const inviteUrl = `https://t.me/share/url?url=https://t.me/${botUsername}&text=${inviteText}`;
            window.tg.openTelegramLink(inviteUrl);
        };

        window.shareResult = function(steps) {
            const botUsername = 'StepStarAppBot'; 
            const message = encodeURIComponent(`–Ø –ø—Ä–æ—à–µ–ª ${steps} —à–∞–≥–æ–≤ –≤ StepStar! üëü`);
            const shareUrl = `https://t.me/share/url?url=https://t.me/${botUsername}&text=${message}`;
            window.tg.openTelegramLink(shareUrl);
        };

        window.processTournamentJoin = function(fee) {
            if (window.userState.coins >= fee) {
                const msg = window.appLang === 'ru' ? `–°–ø–∏—Å–∞—Ç—å ${fee} üí∞?` : `Spend ${fee} üí∞?`;
                window.tg.showConfirm(msg, async (confirm) => {
                    if (confirm) {
                        const userId = window.tg.initDataUnsafe?.user?.id;
                        const userRef = doc(db, "users", String(userId));
                        await updateDoc(userRef, { 
                            "economy.balance": increment(-fee),
                            "tournament.is_registered": true 
                        });
                        window.userState.coins -= fee;
                        window.navigate('tour');
                    }
                });
            }
        };

        // 4. –ó–ê–ü–£–°–ö –ü–†–ò –ó–ê–ì–†–£–ó–ö–ï
        window.onload = async () => {
            window.tg.expand();
            window.tg.ready();

            const tgUser = window.tg.initDataUnsafe?.user;
            if (tgUser) {
                try {
                    const dbData = await syncUser(tgUser);
                    if (dbData) {
                        window.userState.coins = dbData.economy.balance;
                        window.userState.steps = dbData.stats.steps_total;
                        window.userState.isVip = dbData.settings.is_vip;
                        window.userState.frame = dbData.selected.frame || 'white';
                        window.userState.inventoryFrames = dbData.inventory?.frames || ['white'];
                        window.userState.calories = dbData.stats.calories_today || 0;
                    }
                } catch (e) { console.error("Firebase sync error:", e); }
            }

            // –ü–µ—Ä–µ–≤–æ–¥ —Ç–µ–∫—Å—Ç–∞
            if (typeof t === 'function') {
                document.getElementById('txt-home').innerText = t('home', window.appLang);
                document.getElementById('txt-rank').innerText = t('rank', window.appLang);
                document.getElementById('txt-tour').innerText = t('tour', window.appLang);
                document.getElementById('txt-prof').innerText = t('prof', window.appLang);
            }

            window.navigate('home', document.getElementById('btn-home'));
        };
    </script>
</body>
</html>
