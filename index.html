<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>StepStar</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <link rel="stylesheet" href="style.css">
    <script src="https://www.gstatic.com/firebasejs/10.8.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.8.1/firebase-firestore-compat.js"></script>
</head>
<body>
    <div id="app" class="app-viewport">
        <div style="padding:50px; text-align:center; color:white;">ğŸš€ Ğ—Ğ°Ğ¿ÑƒÑĞº StepStar...</div>
    </div>

    <div class="tab-bar">
        <div class="tab-item active" id="btn-home" onclick="navigate('home', this)"><i>ğŸ </i><span id="txt-home">Ğ”Ğ¾Ğ¼</span></div>
        <div class="tab-item" id="btn-rank" onclick="navigate('rank', this)"><i>ğŸ†</i><span id="txt-rank">Ğ Ğ°Ğ½Ğ³</span></div>
        <div class="tab-item" id="btn-tour" onclick="navigate('tour', this)"><i>ğŸ</i><span id="txt-tour">Ğ¢ÑƒÑ€Ğ½Ğ¸Ñ€</span></div>
        <div class="tab-item" id="btn-prof" onclick="navigate('prof', this)"><i>ğŸ‘¤</i><span id="txt-prof">ĞŸÑ€Ğ¾Ñ„Ğ¸Ğ»ÑŒ</span></div>
    </div>

    <script src="assets.js"></script>
    <script src="pages.js"></script>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyD6XgHahHPQ2X0G98sMVGRd-68LigZK4_Q",
            authDomain: "stepstarapp.firebaseapp.com",
            projectId: "stepstarapp",
            storageBucket: "stepstarapp.firebasestorage.app",
            messagingSenderId: "515498492922",
            appId: "1:515498492922:web:76255dfa72995e03261a43"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        window.tg = window.Telegram.WebApp;
        window.userState = { frame: 'white', steps: 0, coins: 0, isVip: false, inventoryFrames: ['white'] };
        window.appLang = (window.tg.initDataUnsafe?.user?.language_code === 'ru') ? 'ru' : 'en';

        window.navigate = function(pageId, el) {
            const app = document.getElementById('app');
            const user = window.tg.initDataUnsafe?.user || { first_name: "User", photo_url: "" };
            if (Pages[pageId]) app.innerHTML = Pages[pageId](user, window.userState, window.appLang);
            if (el) {
                document.querySelectorAll('.tab-item').forEach(i => i.classList.remove('active'));
                el.classList.add('active');
            }
        };

        // Ğ¤ÑƒĞ½ĞºÑ†Ğ¸Ğ¸ Ğ´ĞµĞ¹ÑÑ‚Ğ²Ğ¸Ğ¹
        window.shareResult = (steps) => {
            const text = t('shareMsg', window.appLang).replace('{n}', steps);
            window.tg.openTelegramLink(`https://t.me/share/url?url=https://t.me/StepStarAppBot&text=${encodeURIComponent(text)}`);
        };

        window.handleFrameAction = async (id, price) => {
            const userRef = db.collection("users").doc(String(window.tg.initDataUnsafe.user.id));
            if (window.userState.inventoryFrames.includes(id)) {
                window.userState.frame = id;
                await userRef.update({ "selected.frame": id });
            } else if (window.userState.coins >= price) {
                window.userState.coins -= price;
                window.userState.inventoryFrames.push(id);
                window.userState.frame = id;
                await userRef.update({ 
                    "economy.balance": firebase.firestore.FieldValue.increment(-price),
                    "inventory.frames": firebase.firestore.FieldValue.arrayUnion(id),
                    "selected.frame": id
                });
            }
            window.navigate('shop');
        };

        window.handleVipPurchase = async () => {
            if (window.userState.coins < 2500) return window.tg.showAlert("ĞĞµĞ´Ğ¾ÑÑ‚Ğ°Ñ‚Ğ¾Ñ‡Ğ½Ğ¾ ğŸ’°");
            const userRef = db.collection("users").doc(String(window.tg.initDataUnsafe.user.id));
            await userRef.update({
                "economy.balance": firebase.firestore.FieldValue.increment(-2500),
                "settings.is_vip": true,
                "selected.frame": "gold_vip_frame",
                "inventory.frames": firebase.firestore.FieldValue.arrayUnion("gold_vip_frame")
            });
            window.userState.isVip = true; window.userState.coins -= 2500; window.userState.frame = "gold_vip_frame";
            window.navigate('prof');
        };

        async function start() {
            window.tg.ready(); window.tg.expand();
            const tgUser = window.tg.initDataUnsafe?.user;
            if (tgUser) {
                const userRef = db.collection("users").doc(String(tgUser.id));
                const doc = await userRef.get();
                if (doc.exists) {
                    const data = doc.data();
                    window.userState = {
                        steps: data.stats?.steps_today || 0,
                        coins: data.economy?.balance || 0,
                        frame: data.selected?.frame || 'white',
                        isVip: data.settings?.is_vip || false,
                        inventoryFrames: data.inventory?.frames || ['white']
                    };
                } else {
                    await userRef.set({ name: tgUser.first_name, economy: { balance: 0 }, stats: { steps_today: 0 }, inventory: { frames: ['white'] }, selected: { frame: 'white' } });
                }
            }
            document.getElementById('txt-home').innerText = t('home', window.appLang);
            document.getElementById('txt-rank').innerText = t('rank', window.appLang);
            document.getElementById('txt-tour').innerText = t('tour', window.appLang);
            document.getElementById('txt-prof').innerText = t('prof', window.appLang);
            window.navigate('home', document.getElementById('btn-home'));
        }
        start();
    </script>
</body>
</html>
