<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>StepStar</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <link rel="stylesheet" href="style.css">
    <script src="https://www.gstatic.com/firebasejs/10.8.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.8.1/firebase-firestore-compat.js"></script>
</head>
<body>
    <div id="app" class="app-viewport"></div>
    <div class="tab-bar">
        <div class="tab-item active" onclick="navigate('home', this)"><i>ğŸ </i><span>Ğ”Ğ¾Ğ¼</span></div>
        <div class="tab-item" onclick="navigate('rank', this)"><i>ğŸ†</i><span>Ğ Ğ°Ğ½Ğ³</span></div>
        <div class="tab-item" onclick="navigate('tour', this)"><i>ğŸ</i><span>Ğ¢ÑƒÑ€Ğ½Ğ¸Ñ€</span></div>
        <div class="tab-item" onclick="navigate('prof', this)"><i>ğŸ‘¤</i><span>ĞŸÑ€Ğ¾Ñ„Ğ¸Ğ»ÑŒ</span></div>
    </div>

    <script src="assets.js"></script>
    <script src="pages.js"></script>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyD6XgHahHPQ2X0G98sMVGRd-68LigZK4_Q",
            authDomain: "stepstarapp.firebaseapp.com",
            projectId: "stepstarapp",
            storageBucket: "stepstarapp.firebasestorage.app",
            messagingSenderId: "515498492922",
            appId: "1:515498492922:web:76255dfa72995e03261a43"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        window.tg = window.Telegram.WebApp;
        window.userState = { frame: 'white', steps: 0, steps_total: 0, coins: 0, inventoryFrames: ['white'], isRegistered: false, friends: [] };
        window.topUsers = []; window.tourUsers = []; window.friendUsers = [];

        window.navigate = function(pageId, el) {
            const user = window.tg.initDataUnsafe?.user || { first_name: "User" };
            const lang = window.tg.initDataUnsafe?.user?.language_code === 'ru' ? 'ru' : 'en';
            document.getElementById('app').innerHTML = Pages[pageId](user, window.userState, lang);
            if (el) {
                document.querySelectorAll('.tab-item').forEach(i => i.classList.remove('active'));
                el.classList.add('active');
            }
        };

        async function loadData() {
            const tgUser = window.tg.initDataUnsafe?.user;
            if (!tgUser) { window.navigate('home'); return; }

            const startParam = window.tg.initDataUnsafe?.start_param;
            const userRef = db.collection("users").doc(String(tgUser.id));
            let doc = await userRef.get();

            if (!doc.exists) {
                await userRef.set({
                    name: tgUser.first_name, photo_url: tgUser.photo_url || "",
                    friends: startParam ? [String(startParam)] : [],
                    economy: { balance: 10, last_bonus: null },
                    stats: { steps_today: 0, steps_total: 0 },
                    inventory: { frames: ['white'] },
                    selected: { frame: 'white' },
                    tournament: { is_registered: false }
                });
                if (startParam) {
                    await db.collection("users").doc(String(startParam)).update({
                        friends: firebase.firestore.FieldValue.arrayUnion(String(tgUser.id))
                    });
                }
                doc = await userRef.get();
            }

            const d = doc.data();
            window.userState = {
                id: String(tgUser.id),
                steps: d.stats?.steps_today || 0,
                steps_total: d.stats?.steps_total || 0,
                coins: d.economy?.balance || 0,
                frame: d.selected?.frame || 'white',
                inventoryFrames: d.inventory?.frames || ['white'],
                isRegistered: d.tournament?.is_registered || false,
                friends: d.friends || []
            };

            const snapRank = await db.collection("users").orderBy("stats.steps_total", "desc").limit(10).get();
            window.topUsers = snapRank.docs.map(doc => ({ ...doc.data(), steps_total: doc.data().stats.steps_total }));
            
            if (window.userState.friends.length > 0) {
                const fIds = [...window.userState.friends, window.userState.id];
                const fSnap = await db.collection("users").where(firebase.firestore.FieldPath.documentId(), 'in', fIds.slice(0, 10)).get();
                window.friendUsers = fSnap.docs.map(doc => ({ ...doc.data(), steps_today: doc.data().stats.steps_today })).sort((a,b) => b.steps_today - a.steps_today);
            }

            const snapTour = await db.collection("users").where("tournament.is_registered", "==", true).orderBy("stats.steps_today", "desc").limit(10).get();
            window.tourUsers = snapTour.docs.map(doc => ({ ...doc.data(), steps_today: doc.data().stats.steps_today }));

            window.navigate('home');
        }

        window.joinTournament = async () => {
            if (window.userState.coins < 50) { window.tg.showAlert("ĞÑƒĞ¶Ğ½Ğ¾ 50 ğŸ’°!"); return; }
            window.userState.coins -= 50;
            window.userState.isRegistered = true;
            await db.collection("users").doc(window.userState.id).update({
                "economy.balance": window.userState.coins,
                "tournament.is_registered": true
            });
            window.tg.showAlert("Ğ’Ñ‹ Ğ² Ñ‚ÑƒÑ€Ğ½Ğ¸Ñ€Ğµ!");
            await loadData();
        };

        window.handleFrameAction = async (id, price) => {
            const userRef = db.collection("users").doc(window.userState.id);
            if (window.userState.inventoryFrames.includes(id)) {
                window.userState.frame = id;
                await userRef.update({ "selected.frame": id });
            } else if (window.userState.coins >= price) {
                window.userState.coins -= price;
                window.userState.inventoryFrames.push(id);
                window.userState.frame = id;
                await userRef.update({ "economy.balance": window.userState.coins, "inventory.frames": window.userState.inventoryFrames, "selected.frame": id });
            }
            window.navigate('shop');
        };

        window.claimDailyBonus = async () => {
            if (window.userState.steps < 10000) return window.tg.showAlert("ĞÑƒĞ¶Ğ½Ğ¾ 10,000 ÑˆĞ°Ğ³Ğ¾Ğ²!");
            window.userState.coins += 10;
            await db.collection("users").doc(window.userState.id).update({ "economy.balance": window.userState.coins });
            window.tg.showAlert("Ğ‘Ğ¾Ğ½ÑƒÑ Ğ¿Ğ¾Ğ»ÑƒÑ‡ĞµĞ½!");
            window.navigate('shop');
        };

        window.inviteFriends = () => {
            const link = `https://t.me/StepStarAppBot/start?startapp=${window.userState.id}`;
            window.tg.openTelegramLink(`https://t.me/share/url?url=${encodeURIComponent(link)}&text=ĞŸĞ¾Ğ¹Ğ´ĞµĞ¼ Ğ³ÑƒĞ»ÑÑ‚ÑŒ! ğŸ‘Ÿ`);
        };

        loadData();
    </script>
</body>
</html>
