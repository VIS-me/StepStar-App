<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>StepStar</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div id="app" class="app-viewport"></div>

    <div class="tab-bar">
        <div class="tab-item active" id="btn-home" onclick="window.navigate('home', this)"><i>üè†</i><span id="txt-home"></span></div>
        <div class="tab-item" id="btn-rank" onclick="window.navigate('rank', this)"><i>üèÜ</i><span id="txt-rank"></span></div>
        <div class="tab-item" id="btn-tour" onclick="window.navigate('tour', this)"><i>üèÅ</i><span id="txt-tour"></span></div>
        <div class="tab-item" id="btn-prof" onclick="window.navigate('prof', this)"><i>üë§</i><span id="txt-prof"></span></div>
    </div>

    <script src="assets.js"></script>
    <script src="pages.js"></script>

    <script type="module">
        import { syncUser, buyVip } from './firebase-logic.js';

        // 1. –î–µ–ª–∞–µ–º Telegram WebApp –≥–ª–æ–±–∞–ª—å–Ω—ã–º
        window.tg = window.Telegram.WebApp;
        
        // 2. –ì–ª–æ–±–∞–ª—å–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ (—Ç–µ–ø–µ—Ä—å Pages.js –µ–≥–æ —É–≤–∏–¥–∏—Ç)
        window.userState = { 
            frame: 'blue', 
            steps: 0, 
            coins: 0, 
            isVip: false,
            calories: 0 
        };

        const userLang = window.tg.initDataUnsafe?.user?.language_code;
        window.appLang = (userLang === 'ru' || userLang === 'uk') ? userLang : 'en';

        // 3. –§–£–ù–ö–¶–ò–Ø –ù–ê–í–ò–ì–ê–¶–ò–ò
        window.navigate = function(pageId, el) {
            try {
                const app = document.getElementById('app');
                const user = window.tg.initDataUnsafe?.user || { first_name: "User", photo_url: "" };
                
                if (pageId === 'shop') {
                    app.innerHTML = Pages.shop(user, window.userState, window.appLang);
                    return;
                }

                if (typeof Pages !== 'undefined' && Pages[pageId]) {
                    app.innerHTML = Pages[pageId](user, window.userState, window.appLang);
                }

                if (el) {
                    document.querySelectorAll('.tab-item').forEach(i => i.classList.remove('active'));
                    el.classList.add('active');
                }
                if (window.tg.HapticFeedback) window.tg.HapticFeedback.impactOccurred('light');
            } catch (e) {
                console.error("Navigation error:", e);
            }
        };

        // 4. –ü–†–ò–ì–õ–ê–°–ò–¢–¨ –î–†–£–ó–ï–ô
        window.inviteFriends = function() {
            const botUsername = 'StepStarAppBot'; 
            const inviteText = encodeURIComponent("–ü—Ä–∏–≤–µ—Ç! –î–∞–≤–∞–π —Å—á–∏—Ç–∞—Ç—å —à–∞–≥–∏ –≤–º–µ—Å—Ç–µ –≤ StepStar üëü");
            const inviteUrl = `https://t.me/share/url?url=https://t.me/${botUsername}&text=${inviteText}`;
            window.tg.openTelegramLink(inviteUrl);
            if (window.tg.HapticFeedback) window.tg.HapticFeedback.impactOccurred('medium');
        };

        // 5. –ü–û–î–ï–õ–ò–¢–¨–°–Ø –†–ï–ó–£–õ–¨–¢–ê–¢–û–ú
        window.shareResult = function(steps) {
            const botUsername = 'StepStarAppBot'; 
            const message = encodeURIComponent(`–Ø –ø—Ä–æ—à–µ–ª ${steps} —à–∞–≥–æ–≤ –≤ StepStar! –ü—Ä–∏—Å–æ–µ–¥–∏–Ω—è–π—Å—è! üëü`);
            const shareUrl = `https://t.me/share/url?url=https://t.me/${botUsername}&text=${message}`;
            window.tg.openTelegramLink(shareUrl);
        };

        // 6. –í–´–ë–û–† –†–ê–ú–ö–ò
        window.changeFrame = function(color) {
            window.userState.frame = color;
            window.navigate('shop');
            if (window.tg.HapticFeedback) window.tg.HapticFeedback.notificationOccurred('success');
        };

        // 7. –í–°–¢–£–ü–ò–¢–¨ –í –¢–£–†–ù–ò–†
        window.processTournamentJoin = function(fee) {
            if (window.userState.coins >= fee) {
                const msg = window.appLang === 'ru' ? `–°–ø–∏—Å–∞—Ç—å ${fee} üí∞?` : `Spend ${fee} üí∞?`;
                window.tg.showConfirm(msg, (confirm) => {
                    if (confirm) {
                        window.userState.coins -= fee;
                        if (window.tg.HapticFeedback) window.tg.HapticFeedback.notificationOccurred('success');
                        window.navigate('tour');
                    }
                });
            } else {
                window.tg.showAlert(window.appLang === 'ru' ? "–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –º–æ–Ω–µ—Ç!" : "Not enough coins!");
            }
        };

        // 8. –ó–ê–ü–£–°–ö –ü–†–ò –ó–ê–ì–†–£–ó–ö–ï
        window.onload = async () => {
            window.tg.expand();
            window.tg.ready();

            // –ü–µ—Ä–µ–≤–æ–¥ —Ç–∞–±-–±–∞—Ä–∞
            const homeTab = document.getElementById('txt-home');
            if (homeTab && typeof t === 'function') {
                homeTab.innerText = t('home', window.appLang);
                document.getElementById('txt-rank').innerText = t('rank', window.appLang);
                document.getElementById('txt-tour').innerText = t('tour', window.appLang);
                document.getElementById('txt-prof').innerText = t('prof', window.appLang);
            }

            const tgUser = window.tg.initDataUnsafe?.user;
            if (tgUser) {
                try {
                    const dbData = await syncUser(tgUser);
                    if (dbData) {
                        window.userState.coins = dbData.economy.balance;
                        window.userState.steps = dbData.stats.steps_total;
                        window.userState.isVip = dbData.settings.is_vip;
                        window.userState.frame = dbData.selected.frame;
                        window.userState.calories = dbData.stats.calories_today || 0;
                    }
                } catch (e) { console.error("Firebase sync error:", e); }
            }

            window.navigate('home', document.getElementById('btn-home'));
        };
    </script>
</body>
</html>
