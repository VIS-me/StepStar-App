<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>StepStar</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div id="app" class="app-viewport"></div>

    <div class="tab-bar">
        <div class="tab-item active" id="btn-home" onclick="window.navigate('home', this)"><i>üè†</i><span id="txt-home"></span></div>
        <div class="tab-item" id="btn-rank" onclick="window.navigate('rank', this)"><i>üèÜ</i><span id="txt-rank"></span></div>
        <div class="tab-item" id="btn-tour" onclick="window.navigate('tour', this)"><i>üèÅ</i><span id="txt-tour"></span></div>
        <div class="tab-item" id="btn-prof" onclick="window.navigate('prof', this)"><i>üë§</i><span id="txt-prof"></span></div>
    </div>

    <script src="assets.js"></script>
    <script src="pages.js"></script>

    <script type="module">
        // –õ–æ–≤—É—à–∫–∞ –¥–ª—è –æ—Ç–ª–æ–≤–∞ –æ—à–∏–±–æ–∫ (–≤—ã–≤–µ–¥–µ—Ç alert –µ—Å–ª–∏ —á—Ç–æ-—Ç–æ –Ω–µ —Ç–∞–∫)
        window.onerror = function(msg, url, line) {
            alert("–û—à–∏–±–∫–∞: " + msg + "\n–§–∞–π–ª: " + url + "\n–õ–∏–Ω–∏—è: " + line);
        };

        import { syncUser, buyVipInDb, db, doc, updateDoc, increment, arrayUnion } from './firebase-logic.js';

        // –ü—Ä–æ–±—Ä–∞—Å—ã–≤–∞–µ–º –∏–º–ø–æ—Ä—Ç—ã –≤ –≥–ª–æ–±–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ, —á—Ç–æ–±—ã onclick –≤ HTML –∏—Ö –≤–∏–¥–µ–ª
        window.db = db;
        window.doc = doc;
        window.updateDoc = updateDoc;
        window.increment = increment;
        window.arrayUnion = arrayUnion;

        window.tg = window.Telegram.WebApp;
        
        window.userState = { 
            frame: 'white', steps: 0, coins: 0, isVip: false, inventoryFrames: ['white']
        };

        const userLang = window.tg.initDataUnsafe?.user?.language_code;
        window.appLang = (userLang === 'ru' || userLang === 'uk') ? userLang : 'en';

        // –ù–∞–≤–∏–≥–∞—Ü–∏—è
        window.navigate = function(pageId, el) {
            const app = document.getElementById('app');
            const user = window.tg.initDataUnsafe?.user || { first_name: "Walker", photo_url: "" };
            
            if (typeof Pages !== 'undefined' && Pages[pageId]) {
                app.innerHTML = Pages[pageId](user, window.userState, window.appLang);
            } else {
                console.error("Pages not found or pageId invalid:", pageId);
            }

            if (el) {
                document.querySelectorAll('.tab-item').forEach(i => i.classList.remove('active'));
                el.classList.add('active');
            }
            if (window.tg.HapticFeedback) window.tg.HapticFeedback.impactOccurred('light');
        };

        // –ü–æ–∫—É–ø–∫–∞ —Ä–∞–º–æ–∫
        window.handleFrameAction = async function(color, price) {
            const userId = window.tg.initDataUnsafe?.user?.id;
            if (!userId) return;

            const userRef = window.doc(window.db, "users", String(userId));
            const isOwned = window.userState.inventoryFrames.includes(color);

            if (isOwned) {
                window.userState.frame = color;
                await window.updateDoc(userRef, { "selected.frame": color });
                window.navigate('shop');
            } else {
                if (window.userState.coins >= price) {
                    window.tg.showConfirm(`–ö—É–ø–∏—Ç—å –∑–∞ ${price} üí∞?`, async (confirm) => {
                        if (confirm) {
                            try {
                                await window.updateDoc(userRef, {
                                    "economy.balance": window.increment(-price),
                                    "inventory.frames": window.arrayUnion(color),
                                    "selected.frame": color
                                });
                                window.userState.coins -= price;
                                window.userState.frame = color;
                                window.userState.inventoryFrames.push(color);
                                window.navigate('shop');
                                window.tg.HapticFeedback.notificationOccurred('success');
                            } catch (e) { alert("–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–∫—É–ø–∫–µ: " + e.message); }
                        }
                    });
                } else {
                    window.tg.showAlert("–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –º–æ–Ω–µ—Ç!");
                }
            }
        };

        // –ü–æ–∫—É–ø–∫–∞ VIP
        window.handleVipPurchase = async function() {
            const userId = window.tg.initDataUnsafe?.user?.id;
            if (window.userState.coins >= 2500) {
                window.tg.showConfirm("–ö—É–ø–∏—Ç—å VIP –∑–∞ 2500 üí∞?", async (confirm) => {
                    if(confirm) {
                        try {
                            await buyVipInDb(userId);
                            window.userState.isVip = true;
                            window.userState.coins -= 2500;
                            window.userState.frame = 'gold_vip_frame';
                            window.userState.inventoryFrames.push('gold_vip_frame');
                            window.navigate('prof');
                            window.tg.showAlert("üëë VIP –ê–ö–¢–ò–í–ò–†–û–í–ê–ù!");
                        } catch(e) { alert("–û—à–∏–±–∫–∞ VIP: " + e.message); }
                    }
                });
            } else {
                window.tg.showAlert("–ù—É–∂–Ω–æ 2500 –º–æ–Ω–µ—Ç!");
            }
        };

        async function initApp() {
            try {
                window.tg.expand();
                window.tg.ready();
                
                document.getElementById('app').innerHTML = '<div style="padding:50px; text-align:center; color:white;">üöÄ Loading StepStar...</div>';

                const tgUser = window.tg.initDataUnsafe?.user;
                if (tgUser) {
                    const dbData = await syncUser(tgUser);
                    if (dbData) {
                        window.userState.coins = dbData.economy?.balance || 0;
                        window.userState.steps = dbData.stats?.steps_today || 0;
                        window.userState.frame = dbData.selected?.frame || 'white';
                        window.userState.inventoryFrames = dbData.inventory?.frames || ['white'];
                        window.userState.isVip = dbData.settings?.is_vip || false;
                    }
                }

                // –õ–æ–∫–∞–ª–∏–∑–∞—Ü–∏—è –º–µ–Ω—é
                document.getElementById('txt-home').innerText = t('home', window.appLang);
                document.getElementById('txt-rank').innerText = t('rank', window.appLang);
                document.getElementById('txt-tour').innerText = t('tour', window.appLang);
                document.getElementById('txt-prof').innerText = t('prof', window.appLang);

                // –ó–∞–ø—É—Å–∫ –ø–µ—Ä–≤–æ–π —Å—Ç—Ä–∞–Ω–∏—Ü—ã
                window.navigate('home', document.getElementById('btn-home'));
            } catch (e) {
                alert("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è: " + e.message);
            }
        }

        initApp();
    </script>
</body>
</html>
