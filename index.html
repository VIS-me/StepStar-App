<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>StepStar</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <link rel="stylesheet" href="style.css">
    <script src="https://www.gstatic.com/firebasejs/10.8.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.8.1/firebase-firestore-compat.js"></script>
</head>
<body>
    <div id="app" class="app-viewport">
        <div style="padding:50px; text-align:center; color:white;">üöÄ –ó–∞–ø—É—Å–∫ StepStar...</div>
    </div>

    <div class="tab-bar">
        <div class="tab-item active" id="btn-home" onclick="navigate('home', this)"><i>üè†</i><span id="txt-home">–î–æ–º</span></div>
        <div class="tab-item" id="btn-rank" onclick="navigate('rank', this)"><i>üèÜ</i><span id="txt-rank">–†–∞–Ω–≥</span></div>
        <div class="tab-item" id="btn-tour" onclick="navigate('tour', this)"><i>üèÅ</i><span id="txt-tour">–¢—É—Ä–Ω–∏—Ä</span></div>
        <div class="tab-item" id="btn-prof" onclick="navigate('prof', this)"><i>üë§</i><span id="txt-prof">–ü—Ä–æ—Ñ–∏–ª—å</span></div>
    </div>

    <script src="assets.js"></script>
    <script src="pages.js"></script>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyD6XgHahHPQ2X0G98sMVGRd-68LigZK4_Q",
            authDomain: "stepstarapp.firebaseapp.com",
            projectId: "stepstarapp",
            storageBucket: "stepstarapp.firebasestorage.app",
            messagingSenderId: "515498492922",
            appId: "1:515498492922:web:76255dfa72995e03261a43"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        window.tg = window.Telegram.WebApp;
        window.userState = { 
            frame: 'white', steps: 0, steps_week: 0, steps_month: 0, steps_total: 0,
            coins: 0, isVip: false, inventoryFrames: ['white'], last_bonus: null 
        };
        window.topUsers = [];
        window.tourUsers = [];
        window.appLang = (window.tg.initDataUnsafe?.user?.language_code === 'ru') ? 'ru' : 'en';

        // –ì–ª–æ–±–∞–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—Ç—Ä–∏—Å–æ–≤–∫–∏ —Ä–∞–º–æ–∫
        window.getFrameStyle = function(id) {
            const styles = {
                'white': '3px solid #ffffff',
                'green': '3px solid #4CAF50',
                'lightblue': '3px solid #00BCD4',
                'blue': '3px solid #2196F3',
                'pink': '3px solid #E91E63',
                'purple': '3px solid #9C27B0',
                'gold': '3px solid #FFD700',
                'gold_vip_frame': '4px double #FFD700'
            };
            return styles[id] || styles['white'];
        };

        window.navigate = function(pageId, el) {
            const app = document.getElementById('app');
            const user = window.tg.initDataUnsafe?.user || { first_name: "Walker", photo_url: "" };
            if (Pages[pageId]) {
                app.innerHTML = Pages[pageId](user, window.userState, window.appLang);
                window.tg.HapticFeedback?.impactOccurred('light');
            }
            if (el) {
                document.querySelectorAll('.tab-item').forEach(i => i.classList.remove('active'));
                el.classList.add('active');
            }
        };

        async function loadRankings() {
            try {
                const snap = await db.collection("users").orderBy("stats.steps_total", "desc").limit(10).get();
                window.topUsers = snap.docs.map((d, i) => ({ pos: i+1, ...d.data() }));
                const tourSnap = await db.collection("users").where("tournament.is_registered", "==", true)
                    .orderBy("stats.steps_today", "desc").limit(10).get();
                window.tourUsers = tourSnap.docs.map((d, i) => ({ pos: i+1, ...d.data() }));
            } catch (e) { console.error(e); }
        }

        window.inviteFriends = function() {
            const text = "–°–æ—Ä–µ–≤–Ω—É–π—Å—è —Å–æ –º–Ω–æ–π –≤ StepStar! üëü";
            window.tg.openTelegramLink(`https://t.me/share/url?url=https://t.me/StepStarAppBot&text=${encodeURIComponent(text)}`);
        };

        window.buyStars = function(stars, coins) {
            window.tg.showConfirm(`–ö—É–ø–∏—Ç—å ${coins} –º–æ–Ω–µ—Ç –∑–∞ ${stars} ‚≠êÔ∏è?`, (ok) => {
                if(ok) window.tg.showAlert("–î–ª—è –æ–ø–ª–∞—Ç—ã –∑–≤–µ–∑–¥–∞–º–∏ –Ω—É–∂–Ω–æ —Å–æ–∑–¥–∞—Ç—å Invoice –≤ BotFather.");
            });
        };

        window.claimDailyBonus = async function() {
            const today = new Date().toISOString().split('T')[0];
            if (window.userState.last_bonus === today) return window.tg.showAlert("–£–∂–µ –ø–æ–ª—É—á–µ–Ω–æ —Å–µ–≥–æ–¥–Ω—è!");
            if (window.userState.steps < 10000) return window.tg.showAlert("–ù—É–∂–Ω–æ 10,000 —à–∞–≥–æ–≤!");

            const userRef = db.collection("users").doc(String(window.tg.initDataUnsafe.user.id));
            await userRef.update({
                "economy.balance": firebase.firestore.FieldValue.increment(10),
                "economy.last_bonus": today
            });
            window.userState.coins += 10;
            window.userState.last_bonus = today;
            window.tg.showAlert("–ü–æ–ª—É—á–µ–Ω–æ 10 üí∞!");
            window.navigate('shop');
        };

        window.handleFrameAction = async (id, price) => {
            const userRef = db.collection("users").doc(String(window.tg.initDataUnsafe.user.id));
            if (window.userState.inventoryFrames.includes(id)) {
                window.userState.frame = id;
                await userRef.update({ "selected.frame": id });
            } else if (window.userState.coins >= price) {
                window.userState.coins -= price;
                window.userState.inventoryFrames.push(id);
                window.userState.frame = id;
                await userRef.update({ 
                    "economy.balance": firebase.firestore.FieldValue.increment(-price),
                    "inventory.frames": firebase.firestore.FieldValue.arrayUnion(id),
                    "selected.frame": id
                });
            } else {
                window.tg.showAlert("–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –º–æ–Ω–µ—Ç!");
            }
            window.navigate('shop');
        };

        window.joinTournament = async () => {
            if (window.userState.coins < 50) return window.tg.showAlert("–ù—É–∂–Ω–æ 50 üí∞");
            const userRef = db.collection("users").doc(String(window.tg.initDataUnsafe.user.id));
            await userRef.update({
                "economy.balance": firebase.firestore.FieldValue.increment(-50),
                "tournament.is_registered": true
            });
            window.userState.coins -= 50;
            window.tg.showAlert("–í—ã —É—á–∞—Å—Ç–≤—É–µ—Ç–µ!");
            await loadRankings();
            window.navigate('tour');
        };

        async function start() {
            window.tg.ready(); window.tg.expand();
            const tgUser = window.tg.initDataUnsafe?.user;
            if (tgUser) {
                const userRef = db.collection("users").doc(String(tgUser.id));
                const doc = await userRef.get();
                if (doc.exists) {
                    const d = doc.data();
                    window.userState = {
                        steps: d.stats?.steps_today || 0,
                        steps_week: d.stats?.steps_week || 0,
                        steps_month: d.stats?.steps_month || 0,
                        steps_total: d.stats?.steps_total || 0,
                        coins: d.economy?.balance || 0,
                        frame: d.selected?.frame || 'white',
                        inventoryFrames: d.inventory?.frames || ['white'],
                        last_bonus: d.economy?.last_bonus || null
                    };
                }
                await loadRankings();
            }
            window.navigate('home', document.getElementById('btn-home'));
        }
        start();
    </script>
</body>
</html>
