<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>StepStar</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <link rel="stylesheet" href="style.css">
    
    <script src="https://www.gstatic.com/firebasejs/10.8.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.8.1/firebase-firestore-compat.js"></script>
</head>
<body>
    <div id="app" class="app-viewport">
        <div style="padding:50px; text-align:center; color:white;">üöÄ –ó–∞–ø—É—Å–∫ StepStar...</div>
    </div>

    <div class="tab-bar">
        <div class="tab-item active" id="btn-home" onclick="navigate('home', this)"><i>üè†</i><span id="txt-home">–î–æ–º</span></div>
        <div class="tab-item" id="btn-rank" onclick="navigate('rank', this)"><i>üèÜ</i><span id="txt-rank">–†–∞–Ω–≥</span></div>
        <div class="tab-item" id="btn-tour" onclick="navigate('tour', this)"><i>üèÅ</i><span id="txt-tour">–¢—É—Ä–Ω–∏—Ä</span></div>
        <div class="tab-item" id="btn-prof" onclick="navigate('prof', this)"><i>üë§</i><span id="txt-prof">–ü—Ä–æ—Ñ–∏–ª—å</span></div>
    </div>

    <script src="assets.js"></script>
    <script src="pages.js"></script>

    <script>
        // 1. –ù–∞—Å—Ç—Ä–æ–π–∫–∞ Firebase (Compat –≤–µ—Ä—Å–∏—è –¥–ª—è –Ω–∞–¥–µ–∂–Ω–æ—Å—Ç–∏)
        const firebaseConfig = {
            apiKey: "AIzaSyD6XgHahHPQ2X0G98sMVGRd-68LigZK4_Q",
            authDomain: "stepstarapp.firebaseapp.com",
            projectId: "stepstarapp",
            storageBucket: "stepstarapp.firebasestorage.app",
            messagingSenderId: "515498492922",
            appId: "1:515498492922:web:76255dfa72995e03261a43"
        };

        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        // 2. –ì–ª–æ–±–∞–ª—å–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
        window.tg = window.Telegram.WebApp;
        window.userState = { 
            frame: 'white', steps: 0, coins: 0, isVip: false, inventoryFrames: ['white'] 
        };
        const userLang = window.tg.initDataUnsafe?.user?.language_code;
        window.appLang = (userLang === 'ru' || userLang === 'uk') ? userLang : 'en';

        // 3. –§—É–Ω–∫—Ü–∏—è –Ω–∞–≤–∏–≥–∞—Ü–∏–∏
        window.navigate = function(pageId, el) {
            const app = document.getElementById('app');
            const user = window.tg.initDataUnsafe?.user || { first_name: "Walker", photo_url: "" };
            
            if (typeof Pages !== 'undefined' && Pages[pageId]) {
                app.innerHTML = Pages[pageId](user, window.userState, window.appLang);
            }
            if (el) {
                document.querySelectorAll('.tab-item').forEach(i => i.classList.remove('active'));
                el.classList.add('active');
            }
        };

        // 4. –õ–æ–≥–∏–∫–∞ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ (–∑–∞–º–µ–Ω–∞ firebase-logic.js)
        async function syncUser(tgUser) {
            const userRef = db.collection("users").doc(String(tgUser.id));
            const doc = await userRef.get();

            const freshData = {
                name: tgUser.first_name || "Walker",
                photo_url: tgUser.photo_url || "",
                last_seen: firebase.firestore.FieldValue.serverTimestamp()
            };

            if (doc.exists) {
                await userRef.update(freshData);
                return doc.data();
            } else {
                const newUser = {
                    ...freshData,
                    economy: { balance: 0, total_earned: 0 },
                    inventory: { frames: ["white"] },
                    selected: { frame: "white" },
                    stats: { steps_today: 0, calories_today: 0, steps_total: 0 },
                    settings: { is_vip: false, privacy_mode: "public" }
                };
                await userRef.set(newUser);
                return newUser;
            }
        }

        // 5. –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
        async function start() {
            window.tg.ready();
            window.tg.expand();

            try {
                const tgUser = window.tg.initDataUnsafe?.user;
                if (tgUser) {
                    const data = await syncUser(tgUser);
                    window.userState.coins = data.economy?.balance || 0;
                    window.userState.steps = data.stats?.steps_today || 0;
                    window.userState.frame = data.selected?.frame || 'white';
                    window.userState.inventoryFrames = data.inventory?.frames || ['white'];
                    window.userState.isVip = data.settings?.is_vip || false;
                }
            } catch (e) {
                console.error(e);
            }

            // –ü–µ—Ä–µ–≤–æ–¥–∏–º –º–µ–Ω—é
            document.getElementById('txt-home').innerText = t('home', window.appLang);
            document.getElementById('txt-rank').innerText = t('rank', window.appLang);
            document.getElementById('txt-tour').innerText = t('tour', window.appLang);
            document.getElementById('txt-prof').innerText = t('prof', window.appLang);

            window.navigate('home', document.getElementById('btn-home'));
        }

        start();
    </script>
</body>
</html>
