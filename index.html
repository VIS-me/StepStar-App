<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>StepStar</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <link rel="stylesheet" href="style.css">
    <script src="https://www.gstatic.com/firebasejs/10.8.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.8.1/firebase-firestore-compat.js"></script>
</head>
<body>
    <div id="app" class="app-viewport">
        <div style="padding:50px; text-align:center; color:white;">üöÄ –ó–∞–ø—É—Å–∫ StepStar...</div>
    </div>

    <div class="tab-bar">
        <div class="tab-item active" id="btn-home" onclick="navigate('home', this)"><i>üè†</i><span id="txt-home">–î–æ–º</span></div>
        <div class="tab-item" id="btn-rank" onclick="navigate('rank', this)"><i>üèÜ</i><span id="txt-rank">–†–∞–Ω–≥</span></div>
        <div class="tab-item" id="btn-tour" onclick="navigate('tour', this)"><i>üèÅ</i><span id="txt-tour">–¢—É—Ä–Ω–∏—Ä</span></div>
        <div class="tab-item" id="btn-prof" onclick="navigate('prof', this)"><i>üë§</i><span id="txt-prof">–ü—Ä–æ—Ñ–∏–ª—å</span></div>
    </div>

    <script src="assets.js"></script>
    <script src="pages.js"></script>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyD6XgHahHPQ2X0G98sMVGRd-68LigZK4_Q",
            authDomain: "stepstarapp.firebaseapp.com",
            projectId: "stepstarapp",
            storageBucket: "stepstarapp.firebasestorage.app",
            messagingSenderId: "515498492922",
            appId: "1:515498492922:web:76255dfa72995e03261a43"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        window.tg = window.Telegram.WebApp;
        window.userState = { 
            frame: 'white', steps: 0, steps_week: 0, steps_month: 0, steps_total: 0,
            coins: 0, isVip: false, inventoryFrames: ['white'], last_bonus: null 
        };
        window.topUsers = [];
        window.tourUsers = [];
        window.appLang = (window.tg.initDataUnsafe?.user?.language_code === 'ru') ? 'ru' : 'en';

        window.navigate = function(pageId, el) {
            const app = document.getElementById('app');
            const user = window.tg.initDataUnsafe?.user || { first_name: "Walker", photo_url: "" };
            if (Pages[pageId]) {
                app.innerHTML = Pages[pageId](user, window.userState, window.appLang);
                window.tg.HapticFeedback?.impactOccurred('light');
            }
            if (el) {
                document.querySelectorAll('.tab-item').forEach(i => i.classList.remove('active'));
                el.classList.add('active');
            }
        };

        // –ñ–∏–≤—ã–µ —Ä–µ–π—Ç–∏–Ω–≥–∏ –∏–∑ –ë–î
        async function loadRankings() {
            try {
                // –û–±—â–∏–π —Ç–æ–ø (–ø–æ –≤—Å–µ–º —à–∞–≥–∞–º)
                const snap = await db.collection("users").orderBy("stats.steps_total", "desc").limit(10).get();
                window.topUsers = snap.docs.map((d, i) => ({ pos: i+1, ...d.data() }));
                
                // –¢–æ–ø —Ç—É—Ä–Ω–∏—Ä–∞ (–∫—Ç–æ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω –∏ —Å–µ–≥–æ–¥–Ω—è –ø—Ä–æ—à–µ–ª –±–æ–ª—å—à–µ –≤—Å–µ—Ö)
                const tourSnap = await db.collection("users").where("tournament.is_registered", "==", true)
                    .orderBy("stats.steps_today", "desc").limit(10).get();
                window.tourUsers = tourSnap.docs.map((d, i) => ({ pos: i+1, ...d.data() }));
            } catch (e) { console.error("Rank error:", e); }
        }

        // –ö–Ω–æ–ø–∫–∞ –ø—Ä–∏–≥–ª–∞—Å–∏—Ç—å
        window.inviteFriends = function() {
            const text = "–ü—Ä–∏—Å–æ–µ–¥–∏–Ω—è–π—Å—è –∫ StepStar! –î–∞–≤–∞–π —Å–æ—Ä–µ–≤–Ω–æ–≤–∞—Ç—å—Å—è –≤ —à–∞–≥–∞—Ö! üëü‚ú®";
            window.tg.openTelegramLink(`https://t.me/share/url?url=https://t.me/StepStarAppBot&text=${encodeURIComponent(text)}`);
        };

        // –ü–æ–∫—É–ø–∫–∞ –∑–∞ –∑–≤–µ–∑–¥—ã
        window.buyStars = function(stars, coins) {
            window.tg.showConfirm(`–ö—É–ø–∏—Ç—å ${coins} –º–æ–Ω–µ—Ç –∑–∞ ${stars} ‚≠êÔ∏è?`, (ok) => {
                if(ok) window.tg.showAlert("–î–ª—è –∞–∫—Ç–∏–≤–∞—Ü–∏–∏ –ø–ª–∞—Ç–µ–∂–µ–π –Ω–∞—Å—Ç—Ä–æ–π—Ç–µ Invoice –≤ BotFather.");
            });
        };

        // –ï–∂–µ–¥–Ω–µ–≤–Ω—ã–π –±–æ–Ω—É—Å
        window.claimDailyBonus = async function() {
            const today = new Date().toISOString().split('T')[0];
            if (window.userState.last_bonus === today) return window.tg.showAlert("–£–∂–µ –ø–æ–ª—É—á–µ–Ω–æ —Å–µ–≥–æ–¥–Ω—è!");
            if (window.userState.steps < 10000) return window.tg.showAlert("–ù—É–∂–Ω–æ 10,000 —à–∞–≥–æ–≤ –∑–∞ —Å–µ–≥–æ–¥–Ω—è!");

            const userRef = db.collection("users").doc(String(window.tg.initDataUnsafe.user.id));
            await userRef.update({
                "economy.balance": firebase.firestore.FieldValue.increment(10),
                "economy.last_bonus": today
            });
            window.userState.coins += 10;
            window.userState.last_bonus = today;
            window.tg.showAlert("–ù–∞—á–∏—Å–ª–µ–Ω–æ 10 üí∞!");
            window.navigate('shop');
        };

        // –ú–∞–≥–∞–∑–∏–Ω: —Ä–∞–º–∫–∏
        window.handleFrameAction = async (id, price) => {
            const userRef = db.collection("users").doc(String(window.tg.initDataUnsafe.user.id));
            if (window.userState.inventoryFrames.includes(id)) {
                window.userState.frame = id;
                await userRef.update({ "selected.frame": id });
            } else if (window.userState.coins >= price) {
                window.userState.coins -= price;
                window.userState.inventoryFrames.push(id);
                window.userState.frame = id;
                await userRef.update({ 
                    "economy.balance": firebase.firestore.FieldValue.increment(-price),
                    "inventory.frames": firebase.firestore.FieldValue.arrayUnion(id),
                    "selected.frame": id
                });
            }
            window.navigate('shop');
        };

        // –£—á–∞—Å—Ç–∏–µ –≤ —Ç—É—Ä–Ω–∏—Ä–µ
        window.joinTournament = async () => {
            if (window.userState.coins < 50) return window.tg.showAlert("–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ 50 üí∞");
            const userRef = db.collection("users").doc(String(window.tg.initDataUnsafe.user.id));
            await userRef.update({
                "economy.balance": firebase.firestore.FieldValue.increment(-50),
                "tournament.is_registered": true
            });
            window.userState.coins -= 50;
            window.tg.showAlert("–í—ã –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω—ã –≤ —Ç—É—Ä–Ω–∏—Ä–µ!");
            await loadRankings();
            window.navigate('tour');
        };

        async function start() {
            window.tg.ready(); window.tg.expand();
            const tgUser = window.tg.initDataUnsafe?.user;
            if (tgUser) {
                const userRef = db.collection("users").doc(String(tgUser.id));
                const doc = await userRef.get();
                if (doc.exists) {
                    const d = doc.data();
                    window.userState = {
                        steps: d.stats?.steps_today || 0,
                        steps_week: d.stats?.steps_week || 0,
                        steps_month: d.stats?.steps_month || 0,
                        steps_total: d.stats?.steps_total || 0,
                        coins: d.economy?.balance || 0,
                        frame: d.selected?.frame || 'white',
                        isVip: d.settings?.is_vip || false,
                        inventoryFrames: d.inventory?.frames || ['white'],
                        last_bonus: d.economy?.last_bonus || null
                    };
                } else {
                    await userRef.set({ 
                        name: tgUser.first_name, 
                        photo_url: tgUser.photo_url || "",
                        economy: { balance: 0 }, 
                        stats: { steps_today: 0, steps_week: 0, steps_month: 0, steps_total: 0 }, 
                        inventory: { frames: ['white'] }, 
                        selected: { frame: 'white' },
                        tournament: { is_registered: false }
                    });
                }
                await loadRankings();
            }
            window.navigate('home', document.getElementById('btn-home'));
        }
        start();
    </script>
</body>
</html>
