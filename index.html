<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>StepStar</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div id="app" class="app-viewport"></div>

    <div class="tab-bar">
        <div class="tab-item active" id="btn-home" onclick="navigate('home', this)"><i>üè†</i><span id="txt-home"></span></div>
        <div class="tab-item" id="btn-rank" onclick="navigate('rank', this)"><i>üèÜ</i><span id="txt-rank"></span></div>
        <div class="tab-item" id="btn-tour" onclick="navigate('tour', this)"><i>üèÅ</i><span id="txt-tour"></span></div>
        <div class="tab-item" id="btn-prof" onclick="navigate('prof', this)"><i>üë§</i><span id="txt-prof"></span></div>
    </div>

    <script src="assets.js"></script>
    <script src="pages.js"></script>

    <script type="module">
        import { syncUser, buyVip } from './firebase-logic.js';

        const tg = window.Telegram.WebApp;
        
        // –ì–ª–æ–±–∞–ª—å–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ (window –¥–µ–ª–∞–µ—Ç –µ–≥–æ –≤–∏–¥–∏–º—ã–º –¥–ª—è –≤—Å–µ—Ö —Å–∫—Ä–∏–ø—Ç–æ–≤)
        window.userState = { 
            frame: 'blue', 
            steps: 0, 
            coins: 0, 
            isVip: false,
            calories: 0 
        };

        const userLang = tg.initDataUnsafe?.user?.language_code;
        window.appLang = (userLang === 'ru' || userLang === 'uk') ? userLang : 'en';

        // –í—ã–Ω–æ—Å–∏–º –Ω–∞–≤–∏–≥–∞—Ü–∏—é –≤ –≥–ª–æ–±–∞–ª—å–Ω—É—é –æ–±–ª–∞—Å—Ç—å
        window.navigate = function(pageId, el) {
            try {
                const app = document.getElementById('app');
                const user = tg.initDataUnsafe?.user || { first_name: "User", photo_url: "" };
                
                if (typeof Pages !== 'undefined' && Pages[pageId]) {
                    app.innerHTML = Pages[pageId](user, window.userState, window.appLang);
                }

                if (el) {
                    document.querySelectorAll('.tab-item').forEach(i => i.classList.remove('active'));
                    el.classList.add('active');
                }
                if (tg.HapticFeedback) tg.HapticFeedback.impactOccurred('light');
            } catch (e) {
                console.error("Navigation error:", e);
            }
        };

        // –°–ø–µ—Ü–∏–∞–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–∫—É–ø–∫–∏ VIP
        window.handleBuyVip = async () => {
            const success = await buyVip(tg.initDataUnsafe.user.id);
            if (success) {
                // –û–±–Ω–æ–≤–ª—è–µ–º –ª–æ–∫–∞–ª—å–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –ø–æ—Å–ª–µ –ø–æ–∫—É–ø–∫–∏
                window.userState.isVip = true;
                window.userState.coins -= 2500;
                window.navigate('prof');
            }
        };

        // –õ–æ–≥–∏–∫–∞ –≤—Å—Ç—É–ø–ª–µ–Ω–∏—è –≤ —Ç—É—Ä–Ω–∏—Ä (—Ç–µ–ø–µ—Ä—å –≤–Ω—É—Ç—Ä–∏ –º–æ–¥—É–ª—è)
        window.processTournamentJoin = function(fee) {
            if (window.userState.coins >= fee) {
                const msg = window.appLang === 'ru' ? `–°–ø–∏—Å–∞—Ç—å ${fee} üí∞?` : `Spend ${fee} üí∞?`;
                tg.showConfirm(msg, async (confirm) => {
                    if (confirm) {
                        // –ó–¥–µ—Å—å –≤ –±—É–¥—É—â–µ–º –¥–æ–±–∞–≤–∏–º updateDoc –≤ Firebase
                        window.userState.coins -= fee;
                        if (tg.HapticFeedback) tg.HapticFeedback.notificationOccurred('success');
                        window.navigate('tour');
                    }
                });
            } else {
                tg.showAlert(window.appLang === 'ru' ? "–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –º–æ–Ω–µ—Ç!" : "Not enough coins!");
            }
        };

        // –ó–∞–ø—É—Å–∫ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
        window.onload = async () => {
            tg.expand();
            tg.ready();

            // –ü–µ—Ä–µ–≤–æ–¥ –∫–Ω–æ–ø–æ–∫ –º–µ–Ω—é
            if (typeof t === 'function') {
                document.getElementById('txt-home').innerText = t('home', window.appLang);
                document.getElementById('txt-rank').innerText = t('rank', window.appLang);
                document.getElementById('txt-tour').innerText = t('tour', window.appLang);
                document.getElementById('txt-prof').innerText = t('prof', window.appLang);
            }

            const tgUser = tg.initDataUnsafe?.user;
            if (tgUser) {
                const dbData = await syncUser(tgUser);
                if (dbData) {
                    window.userState.coins = dbData.economy.balance;
                    window.userState.steps = dbData.stats.steps_total;
                    window.userState.isVip = dbData.settings.is_vip;
                    window.userState.frame = dbData.selected.frame;
                    window.userState.calories = dbData.stats.calories_total || 0;
                }
            }

            window.navigate('home', document.getElementById('btn-home'));
        };
    </script>
</body>
</html>
