<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>StepStar</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div id="app" class="app-viewport"></div>

    <div class="tab-bar">
        <div class="tab-item active" id="btn-home" onclick="navigate('home', this)"><i>üè†</i><span id="txt-home"></span></div>
        <div class="tab-item" id="btn-rank" onclick="navigate('rank', this)"><i>üèÜ</i><span id="txt-rank"></span></div>
        <div class="tab-item" id="btn-tour" onclick="navigate('tour', this)"><i>üèÅ</i><span id="txt-tour"></span></div>
        <div class="tab-item" id="btn-prof" onclick="navigate('prof', this)"><i>üë§</i><span id="txt-prof"></span></div>
    </div>

    <script src="assets.js"></script>
    <script src="pages.js"></script>

    <script type="module">
        import { syncUser, buyVip } from './firebase-logic.js';

        const tg = window.Telegram.WebApp;
        
        // –ù–∞—á–∞–ª—å–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ (–±—É–¥–µ—Ç –æ–±–Ω–æ–≤–ª–µ–Ω–æ –∏–∑ –±–∞–∑—ã)
        window.userState = { 
            frame: 'blue', 
            steps: 0, 
            coins: 0, 
            isVip: false,
            calories: 0 
        };

        const userLang = tg.initDataUnsafe?.user?.language_code;
        window.appLang = (userLang === 'ru' || userLang === 'uk') ? userLang : 'en';

        // –ì–ª–æ–±–∞–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –¥–ª—è –∫–Ω–æ–ø–æ–∫ (—á—Ç–æ–±—ã —Ä–∞–±–æ—Ç–∞–ª–∏ –∏–∑ HTML)
        window.navigate = function(pageId, el) {
            try {
                const app = document.getElementById('app');
                const user = tg.initDataUnsafe?.user || { first_name: "User", photo_url: "" };
                
                if (typeof Pages !== 'undefined' && Pages[pageId]) {
                    app.innerHTML = Pages[pageId](user, window.userState, window.appLang);
                }

                if (el) {
                    document.querySelectorAll('.tab-item').forEach(i => i.classList.remove('active'));
                    el.classList.add('active');
                }
                if (tg.HapticFeedback) tg.HapticFeedback.impactOccurred('light');
            } catch (e) {
                console.error("Navigation error:", e);
            }
        };

        // –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ
        window.onload = async () => {
            tg.expand();
            tg.ready();

            // –ü–µ—Ä–µ–≤–æ–¥ —Ç–∞–±-–±–∞—Ä–∞
            document.getElementById('txt-home').innerText = t('home', window.appLang);
            document.getElementById('txt-rank').innerText = t('rank', window.appLang);
            document.getElementById('txt-tour').innerText = t('tour', window.appLang);
            document.getElementById('txt-prof').innerText = t('prof', window.appLang);

            const tgUser = tg.initDataUnsafe?.user;
            if (tgUser) {
                // –ü–û–õ–£–ß–ê–ï–ú –î–ê–ù–ù–´–ï –ò–ó FIREBASE
                const dbData = await syncUser(tgUser);
                if (dbData) {
                    window.userState.coins = dbData.economy.balance;
                    window.userState.steps = dbData.stats.steps_total;
                    window.userState.isVip = dbData.settings.is_vip;
                    window.userState.frame = dbData.selected.frame;
                }
            }

            navigate('home', document.getElementById('btn-home'));
        };
    </script>

    <script>
        function processTournamentJoin(fee) {
            if (window.userState.coins >= fee) {
                const msg = window.appLang === 'ru' ? `–°–ø–∏—Å–∞—Ç—å ${fee} üí∞?` : `Spend ${fee} üí∞?`;
                window.Telegram.WebApp.showConfirm(msg, (confirm) => {
                    if (confirm) {
                        // –¢—É—Ç –¥–æ–±–∞–≤–∏–º –≤—ã–∑–æ–≤ —Ñ—É–Ω–∫—Ü–∏–∏ —Å–ø–∏—Å–∞–Ω–∏—è –∏–∑ Firebase –≤ –±—É–¥—É—â–µ–º
                        window.userState.coins -= fee;
                        navigate('tour');
                    }
                });
            }
        }
    </script>
</body>
</html>
