<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>StepStar</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div id="app" class="app-viewport"></div>

    <div class="tab-bar">
        <div class="tab-item active" id="btn-home" onclick="window.navigate('home', this)"><i>üè†</i><span id="txt-home"></span></div>
        <div class="tab-item" id="btn-rank" onclick="window.navigate('rank', this)"><i>üèÜ</i><span id="txt-rank"></span></div>
        <div class="tab-item" id="btn-tour" onclick="window.navigate('tour', this)"><i>üèÅ</i><span id="txt-tour"></span></div>
        <div class="tab-item" id="btn-prof" onclick="window.navigate('prof', this)"><i>üë§</i><span id="txt-prof"></span></div>
    </div>

    <script src="assets.js"></script>
    <script src="pages.js"></script>

    <script type="module">
        import { syncUser, db, doc, updateDoc, increment, arrayUnion } from './firebase-logic.js';

        window.tg = window.Telegram.WebApp;
        
        window.userState = { 
            frame: 'white', 
            steps: 0, 
            coins: 0, 
            isVip: false,
            inventoryFrames: ['white']
        };

        const userLang = window.tg.initDataUnsafe?.user?.language_code;
        window.appLang = (userLang === 'ru' || userLang === 'uk') ? userLang : 'en';

        window.navigate = function(pageId, el) {
            const app = document.getElementById('app');
            const user = window.tg.initDataUnsafe?.user || { first_name: "User", photo_url: "" };
            
            if (typeof Pages !== 'undefined' && Pages[pageId]) {
                app.innerHTML = Pages[pageId](user, window.userState, window.appLang);
            }

            if (el) {
                document.querySelectorAll('.tab-item').forEach(i => i.classList.remove('active'));
                el.classList.add('active');
            }
            if (window.tg.HapticFeedback) window.tg.HapticFeedback.impactOccurred('light');
        };

        window.handleFrameAction = async function(color, price) {
            const userId = window.tg.initDataUnsafe?.user?.id;
            if (!userId) return;

            const userRef = doc(db, "users", String(userId));
            const isOwned = window.userState.inventoryFrames.includes(color);

            if (isOwned) {
                window.userState.frame = color;
                await updateDoc(userRef, { "selected.frame": color });
                window.navigate('shop');
            } else {
                if (window.userState.coins >= price) {
                    window.tg.showConfirm(`–ö—É–ø–∏—Ç—å –∑–∞ ${price} üí∞?`, async (confirm) => {
                        if (confirm) {
                            try {
                                await updateDoc(userRef, {
                                    "economy.balance": increment(-price),
                                    "inventory.frames": arrayUnion(color),
                                    "selected.frame": color
                                });
                                window.userState.coins -= price;
                                window.userState.frame = color;
                                window.userState.inventoryFrames.push(color);
                                window.navigate('shop');
                                window.tg.HapticFeedback.notificationOccurred('success');
                            } catch (e) { console.error(e); }
                        }
                    });
                } else {
                    window.tg.showAlert("–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –º–æ–Ω–µ—Ç!");
                }
            }
        };

        window.inviteFriends = function() {
            const botUrl = `https://t.me/share/url?url=https://t.me/StepStarAppBot&text=${encodeURIComponent(t('shareMsg', window.appLang).replace('{n}', window.userState.steps))}`;
            window.tg.openTelegramLink(botUrl);
        };

        window.shareResult = function(steps) {
            const botUrl = `https://t.me/share/url?url=https://t.me/StepStarAppBot&text=${encodeURIComponent(t('shareMsg', window.appLang).replace('{n}', steps))}`;
            window.tg.openTelegramLink(botUrl);
        };

        async function initApp() {
            window.tg.expand();
            window.tg.ready();

            const tgUser = window.tg.initDataUnsafe?.user;
            if (tgUser) {
                try {
                    const dbData = await syncUser(tgUser);
                    if (dbData) {
                        window.userState.coins = dbData.economy?.balance || 0;
                        window.userState.steps = dbData.stats?.steps_total || 0;
                        window.userState.frame = dbData.selected?.frame || 'white';
                        window.userState.inventoryFrames = dbData.inventory?.frames || ['white'];
                    }
                } catch (e) { console.error("Firebase error:", e); }
            }

            // –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –Ω–∞–∑–≤–∞–Ω–∏–π –≤ –º–µ–Ω—é
            document.getElementById('txt-home').innerText = t('home', window.appLang);
            document.getElementById('txt-rank').innerText = t('rank', window.appLang);
            document.getElementById('txt-tour').innerText = t('tour', window.appLang);
            document.getElementById('txt-prof').innerText = t('prof', window.appLang);

            // –ü–µ—Ä–≤–∞—è –∑–∞–≥—Ä—É–∑–∫–∞
            window.navigate('home', document.getElementById('btn-home'));
        }

        initApp();
    </script>
</body>
</html>
